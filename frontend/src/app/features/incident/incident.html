<main class="incidents-page">
  <div class="container">

    <!-- Page Header -->
    <div class="page-header">
      <div>
        <h1 class="page-title">Incident Management</h1>
        <p class="page-subtitle">Manage reported incidents</p>
      </div>
      <div class="page-actions">
        <app-button variant="outline" (click)="goToDashboard()">
          üìä Dashboard
        </app-button>
        <app-button variant="primary" (click)="openAddIncidentModal()">
          + Add Incident
        </app-button>
      </div>
    </div>

    <!-- Loading Spinner -->
    <div *ngIf="isLoading" class="loading-container">
      <app-loading-spinner message="Loading incidents..."></app-loading-spinner>
    </div>

    <!-- Incidents List -->
    <div *ngIf="!isLoading">

      <!-- Filter Bar -->
      <div class="filter-bar">
        <div class="filter-group">
          <label for="filter-status" class="filter-label">Status:</label>
          <select id="filter-status" [(ngModel)]="filterStatus" class="filter-select">
            <option value="all">All Statuses</option>
            <option value="OPEN">Open</option>
            <option value="IN PROGRESS">In Progress</option>
            <option value="RESOLVED">Resolved</option>
            <option value="CLOSED">Closed</option>
          </select>
        </div>
        <div class="filter-info">
          <span class="info-text">{{ filteredIncidents.length }} incidents</span>
        </div>
      </div>

      <!-- Incidents Grid -->
      <div class="incidents-section">
        <h2 class="section-title">Reported Incidents</h2>
        <div class="incidents-grid">

          <app-card
            *ngFor="let incident of filteredIncidents"
            [hoverable]="true"
            padding="md"
            class="incident-card"
            (click)="selectIncident(incident)"
          >
            <div class="incident-header">
              <div class="incident-info">
                <h3 class="incident-type">‚ö†Ô∏è {{ incident.type }}</h3>
                <p class="incident-status">{{ incident.status }}</p>
              </div>
            </div>

            <div class="incident-details">
              <div class="detail-item">
                <span class="detail-label">Severity:</span>
                <span class="detail-value">{{ getSeverityLabel(incident.severity) }}</span>
              </div>

              <div class="detail-item" *ngIf="incident.reportedAt">
                <span class="detail-label">Reported:</span>
                <span class="detail-value">{{ formatDate(incident.reportedAt) }}</span>
              </div>

              <!-- Coordinates -->
              <div class="detail-item">
                <span class="detail-label">Location:</span>
                <span class="detail-value">
                  {{ getLatitude(incident) }}, {{ getLongitude(incident) }}
                </span>
              </div>
            </div>

          </app-card>

          <div *ngIf="filteredIncidents.length === 0" class="no-incidents">
            <p>No incidents match the selected filters</p>
          </div>

        </div>
      </div>

    </div>
  </div>
</main>

<!-- Incident Details Modal -->
<app-modal
  [isOpen]="selectedIncident !== null"
  [title]="selectedIncident?.type || ''"
  size="md"
  (close)="deselectIncident()"
>
  <div *ngIf="selectedIncident" class="incident-details-modal">

    <h3>{{ selectedIncident.type }}</h3>

    <div class="detail-row">
      <span class="detail-label">Status:</span>
      <span class="detail-value">{{ selectedIncident.status }}</span>
    </div>

    <div class="detail-row">
      <span class="detail-label">Severity:</span>
      <span class="detail-value">{{ getSeverityLabel(selectedIncident.severity) }}</span>
    </div>

    <div class="detail-row" *ngIf="selectedIncident.description">
      <span class="detail-label">Description:</span>
      <span class="detail-value">{{ selectedIncident.description }}</span>
    </div>

    <div class="detail-row">
      <span class="detail-label">Location:</span>
      <span class="detail-value">
        {{ getLatitude(selectedIncident) }}, {{ getLongitude(selectedIncident) }}
      </span>
    </div>

    <div class="detail-row" *ngIf="selectedIncident.reportedAt">
      <span class="detail-label">Reported:</span>
      <span class="detail-value">{{ formatDate(selectedIncident.reportedAt) }}</span>
    </div>

    <div class="detail-row" *ngIf="selectedIncident.resolvedAt">
      <span class="detail-label">Resolved:</span>
      <span class="detail-value">{{ formatDate(selectedIncident.resolvedAt) }}</span>
    </div>

    <div class="modal-actions">
      <app-button
        variant="primary"
        size="sm"
        [disabled]="selectedIncident.status === 'RESOLVED' || selectedIncident.status === 'CLOSED'"
        (click)="resolveIncident(selectedIncident.id)">
        Resolve Incident
      </app-button>
      <app-button variant="outline" size="sm" (click)="onDeleteIncident(selectedIncident.id)">
        Delete Incident
      </app-button>
    </div>

  </div>
</app-modal>

<!-- Create/Edit Modal -->
<app-modal
  [isOpen]="isIncidentFormModalOpen"
  [title]="formMode === 'create' ? 'Add New Incident' : 'Edit Incident'"
  size="md"
  (close)="closeIncidentFormModal()"
>
  <form (ngSubmit)="onSubmitIncidentForm()" class="add-incident-form">

    <div class="form-group">
      <label class="form-label">Type</label>
      <select [(ngModel)]="incidentForm.type" name="type" class="form-input" required>
        <option value="BLOCKED_STREET">Blocked Street</option>
        <option value="TRAFFIC_ACCIDENT">Traffic Accident</option>
        <option value="POLICE_ACTIVITY">Police Activity</option>
        <option value="ROAD_MAINTENANCE">Road Maintenance</option>
        <option value="PUBLIC_EVENT">Public Event</option>
        <option value="NATURAL_OBSTRUCTION">Natural Obstruction</option>
        <option value="FIRE_BLOCKAGE">Fire Blockage</option>
        <option value="OTHER">Other</option>
      </select>
    </div>

    <div class="form-group">
      <label class="form-label">Severity</label>
      <select [(ngModel)]="incidentForm.severity" name="severity" class="form-input" required>
        <option value="LOW">Low</option>
        <option value="MEDIUM">Medium</option>
        <option value="HIGH">High</option>
        <option value="CRITICAL">Critical</option>
      </select>
    </div>

    <div class="form-group">
      <label class="form-label">Status</label>
      <select [(ngModel)]="incidentForm.status" name="status" class="form-input" required>
        <option value="OPEN">Open</option>
        <option value="IN PROGRESS">In Progress</option>
        <option value="RESOLVED">Resolved</option>
        <option value="CLOSED">Closed</option>
      </select>
    </div>

    <div class="form-group">
      <label class="form-label">Description</label>
      <textarea [(ngModel)]="incidentForm.description" name="description" class="form-input"></textarea>
    </div>

    <!-- Coordinates Inputs -->
    <div class="form-group">
      <label class="form-label">Longitude</label>
      <input type="number" [(ngModel)]="incidentFormCoordinates.longitude" name="longitude" class="form-input" required>
    </div>

    <div class="form-group">
      <label class="form-label">Latitude</label>
      <input type="number" [(ngModel)]="incidentFormCoordinates.latitude" name="latitude" class="form-input" required>
    </div>

    <div class="modal-actions">
      <app-button type="button" variant="outline" (click)="closeIncidentFormModal()">Cancel</app-button>
      <app-button type="submit" variant="primary">
        {{ formMode === 'create' ? 'Add Incident' : 'Save Changes' }}
      </app-button>
    </div>

  </form>
</app-modal>
