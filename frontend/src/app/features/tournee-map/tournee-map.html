<!-- Toasts -->
<div *ngIf="assignSuccessMessage" class="toast toast-success">
  <span class="toast-icon">‚úÖ</span>
  <span class="toast-text">{{ assignSuccessMessage }}</span>
</div>

<div *ngIf="assignErrorMessage" class="toast toast-error">
  <span class="toast-icon">‚ö†Ô∏è</span>
  <span class="toast-text">{{ assignErrorMessage }}</span>
</div>

<main class="map-page" [class.with-details]="selectedStop">
  <div class="map-container">
    <!-- Filter / Planning Bar (ADMIN ONLY) -->
    <div class="filter-bar" *ngIf="isAdmin">
      <!-- Waste types: admin chooses tour type here -->
      <div class="filter-group waste-type-group">
        <span class="filter-label">Waste types:</span>
        <div class="filter-checkboxes">
          <label
            class="filter-checkbox"
            *ngFor="let type of trashTypes"
            [ngClass]="'filter-checkbox--' + type">

            <input
              type="checkbox"
              class="filter-checkbox-input"
              [value]="type"
              [checked]="isTypeSelected(type)"
              (change)="onWasteTypeToggle(type, $event.target.checked)" />

            <span class="filter-checkbox-box"></span>

            <span class="filter-checkbox-label">
              {{ type | titlecase }}
            </span>
          </label>
        </div>
      </div>

      <div class="filter-group">
        <label for="threshold" class="filter-label">Fill threshold (%):</label>
        <input
          id="threshold"
          type="number"
          class="filter-select"
          [(ngModel)]="threshold"
          min="0"
          max="100"
          step="5" />
      </div>

      <!-- Admin action buttons -->

      <div class="filter-actions">

        <ng-container *ngIf="adminViewMode === 'IN_PROGRESS'; else planningActions">

          <!-- Initial state: view in-progress tours -->

          <app-button

            variant="primary"

            (click)="startPlanning()">

            Plan

          </app-button>

        </ng-container>



        <ng-template #planningActions>

          <!-- Planning state -->

          <app-button

            variant="primary"

            (click)="terminatePlanning()">

            Done

          </app-button>



          <app-button

            variant="outline"

            [disabled]="!tours.length || isAssigning"

            (click)="assignResourcesForAll()">

            {{ isAssigning ? 'Assign?' : 'Assign all' }}

          </app-button>



          <app-button

            variant="ghost"

            [disabled]="!tours.length"

            (click)="discardAllTours()">

            Clear unassigned

          </app-button>

        </ng-template>

      </div>

      <app-button variant="outline" (click)="goToDashboard()">
          üìä Dashboard
        </app-button>

    </div>

    <!-- Map and Sidebar -->
    <div class="map-content">
      <!-- Map View -->
      <div class="map-view">
        <div id="tourneeMap" class="map-canvas"></div>

        <!-- Loading overlay -->
        <div *ngIf="isLoading" class="map-overlay">
          <app-loading-spinner
            [message]="
              isAdmin
                ? 'Planning tours and loading map...'
                : 'Loading map and your tour...'
            ">
          </app-loading-spinner>
        </div>

        <!-- Placeholder when no tours AND no initial points -->
        <div
          *ngIf="!isLoading && !tours.length && !hasInitialPoints"
          class="map-overlay">
          <div class="map-placeholder-content">
            <p class="map-placeholder-icon">üó∫Ô∏è</p>
            <h3 class="map-placeholder-title">
              {{ isAdmin ? 'Plan collection tours' : 'No tour assigned yet' }}
            </h3>
            <p
              class="map-placeholder-text"
              *ngIf="isAdmin">
              Select one or more waste types and a threshold, then click "Plan tours"
              to generate optimized routes from the depot to the collection points
              that need service.
            </p>
            <p
              class="map-placeholder-text"
              *ngIf="!isAdmin">
              There is currently no in-progress tour for you. Once your manager assigns one,
              it will appear here.
            </p>
          </div>
        </div>
      </div>

      <!-- Tours + Stops Sidebar -->
      <div class="bins-sidebar">
        <app-card padding="md" class="bins-list-card">
          <h2 class="sidebar-title">
            {{ isAdmin ? 'Planned tours' : 'My tour' }}
            <span *ngIf="tours.length">({{ tours.length }})</span>
          </h2>


          <div *ngIf="tours.length; else noTours" class="tours-list">
            <div
              *ngFor="let tourView of tours; let ti = index"
              class="tour-card"
              [class.tour-active]="ti === activeTourIndex"
              (click)="focusTour(ti, $event)">

              <!-- Tour header -->
              <div class="tour-card-header">
                <div class="tour-main-info">
                  <div class="tour-title">
                    Tour #{{ ti + 1 }}
                    <span
                      class="tour-type-pill"
                      [ngClass]="'tour-type-pill--' + tourView.tournee.tourneeType">
                      {{ tourView.tournee.tourneeType | titlecase }}
                    </span>
                  </div>
                  <div class="tour-meta">
                    <span>
                      {{ tourView.tournee.plannedKm | number:'1.2-2' }} km
                    </span>
                    <span *ngIf="tourView.stops.length">
                      ¬∑ {{ tourView.stops.length }} stops
                    </span>
                    <span *ngIf="tourView.tournee.status">
                      ¬∑ {{ tourView.tournee.status }}
                    </span>
                  </div>
                  <div class="tour-meta" *ngIf="tourView.vehicleDisplay">
                    <span>
                      Vehicle: {{ tourView.vehicleDisplay.plateNumber }}
                    </span>
                    <span>
                      ¬∑ {{ tourView.vehicleDisplay.capacityVolumeL | number:'1.0-0' }} L
                    </span>
                  </div>
                </div>

                <!-- Admin-only actions -->
                <div class="tour-card-actions" *ngIf="isAdmin">
                  <!-- PLANNING actions -->
                  <ng-container *ngIf="adminViewMode === 'PLANNING'; else inProgressActions">
                    <app-button
                      size="sm"
                      variant="outline"
                      [disabled]="tourView.isAssigning"
                      (click)="assignResourcesForTour(tourView, $event)">
                      {{ tourView.isAssigning ? 'Assigning...' : 'Assign' }}
                    </app-button>

                    <app-button
                      size="sm"
                      variant="ghost"
                      (click)="discardTour(tourView, ti); $event.stopPropagation()">
                      Delete
                    </app-button>
                  </ng-container>

                  <!-- IN_PROGRESS actions -->
                  <ng-template #inProgressActions>
                    <app-button
                      size="sm"
                      variant="ghost"
                      (click)="discardTour(tourView, ti); $event.stopPropagation()">
                      Delete
                    </app-button>
                  </ng-template>
                </div>
              </div>

              <!-- Steps for this tour -->
              <div class="tour-steps">
                <div
                  *ngFor="let stop of tourView.stops"
                  class="bin-item"
                  (click)="selectStop(ti, stop); $event.stopPropagation()"
                  [class.bin-selected]="
                    selectedStop &&
                    selectedStop.step.id === stop.step.id &&
                    ti === activeTourIndex
                  ">
                  <div class="bin-item-header">
                    <span class="bin-icon" aria-hidden="true">
                      {{ getTrashTypeIcon(tourView.tournee.tourneeType) }}
                    </span>
                    <div class="bin-info">
                      <span class="bin-id">
                        Stop #{{ stop.step.order }}
                      </span>
                      <span class="bin-type">
                        {{ stop.collectionPoint.adresse || stop.collectionPoint.id }}
                      </span>
                    </div>
                  </div>

                  <span [class]="getStatusBadgeClass(stop.step.status)">
                    {{ stop.step.status }}
                  </span>
                </div>

                <div *ngIf="!tourView.stops.length" class="no-bins">
                  <p>No collection points in this tour.</p>
                </div>
              </div>
            </div>
          </div>

          <ng-template #noTours>
            <div class="no-bins">
              <p>
                {{ isAdmin ? 'No tours planned yet.' : 'No tour in progress for now.' }}
              </p>
            </div>
          </ng-template>
        </app-card>
      </div>
    </div>
  </div>
</main>

<!-- Details Panel -->
<div
  class="details-panel"
  [class.panel-open]="selectedStop"
  *ngIf="selectedStop && activeTour">
  <div class="panel-header">
    <h2 class="panel-title">Collection point details</h2>
    <button
      class="panel-close"
      (click)="closeDetailsPanel()"
      aria-label="Close details panel">
      ‚úï
    </button>
  </div>

  <div class="panel-content">
    <div class="detail-section">
      <div class="detail-icon">
        {{ activeTour ? getTrashTypeIcon(activeTour.tournee.tourneeType) : 'üóëÔ∏è' }}
      </div>
      <h3 class="detail-heading">
        Stop #{{ selectedStop.step.order }}
      </h3>
      <p class="map-placeholder-text" style="text-align: center;">
        {{ selectedStop.collectionPoint.adresse || selectedStop.collectionPoint.id }}
      </p>
    </div>

    <div class="detail-section">
      <h4 class="detail-subheading">Location</h4>
      <div class="detail-row">
        <span class="detail-label">Address:</span>
        <span class="detail-value">
          {{ selectedStop.collectionPoint.adresse || 'N/A' }}
        </span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Latitude:</span>
        <span class="detail-value">
          {{ selectedStop.collectionPoint.location.coordinates[1] }}
        </span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Longitude:</span>
        <span class="detail-value">
          {{ selectedStop.collectionPoint.location.coordinates[0] }}
        </span>
      </div>
    </div>

    <div class="detail-section">
      <h4 class="detail-subheading">Tour info</h4>
      <div class="detail-row">
        <span class="detail-label">Tour type:</span>
        <span class="detail-value">
          {{ activeTour.tournee.tourneeType | titlecase }}
        </span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Planned distance:</span>
        <span class="detail-value">
          {{ activeTour.tournee.plannedKm | number: '1.2-2' }} km
        </span>
      </div>
      <div class="detail-row" *ngIf="activeTour.tournee.status">
        <span class="detail-label">Status:</span>
        <span class="detail-value">
          {{ activeTour.tournee.status }}
        </span>
      </div>
    </div>

    <!-- Assigned resources -->
    <div
      class="detail-section"
      *ngIf="activeTour.assignments && activeTour.assignments.length">
      <h4 class="detail-subheading">Assigned resources</h4>

      <!-- Vehicle info -->
      <div class="detail-row">
        <span class="detail-label">Vehicle:</span>
        <span class="detail-value" *ngIf="activeTour.vehicleDisplay; else vehicleIdOnly">
          {{ activeTour.vehicleDisplay.plateNumber }}
          ¬∑
          {{ activeTour.vehicleDisplay.capacityVolumeL | number:'1.0-0' }} L
        </span>
        <ng-template #vehicleIdOnly>
          <span class="detail-value">
            {{ activeTour.assignments[0]?.vehicleId }}
          </span>
        </ng-template>
      </div>

      <!-- Crew list -->
      <div class="detail-row">
        <span class="detail-label">Crew:</span>
        <span class="detail-value">
          <div class="crew-list">
            <div class="crew-chip" *ngFor="let c of activeTour.crewDisplay">
              <div class="crew-avatar">
                {{ c.fullName ? (c.fullName | slice:0:1) : 'üë§' }}
              </div>
              <div class="crew-info">
                <div class="crew-name">{{ c.fullName }}</div>
                <div class="crew-role">{{ c.role }}</div>
              </div>
            </div>
          </div>
        </span>
      </div>

      <!-- Shift -->
      <div class="detail-row">
        <span class="detail-label">Shift:</span>
        <span class="detail-value">
          {{ activeTour.assignments[0]?.shiftStart | date:'short' }}
          ‚Äì
          {{ activeTour.assignments[0]?.shiftEnd | date:'short' }}
        </span>
      </div>
    </div>
  </div>
</div>
