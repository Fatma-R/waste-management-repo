<main class="bin-readings-page">
  <div class="container">
    <!-- Page Header -->
    <div class="page-header">
      <div class="header-content">
        <div class="header-title-section">
          <div class="back-button-wrapper">
            <app-button variant="outline" size="sm" (click)="goBackToBins()">
              ‚Üê Back to Bins
            </app-button>
          </div>
          <h1 class="page-title">Bin Readings</h1>
          <p class="page-subtitle">Monitor and view sensor readings for this bin</p>
        </div>
      </div>

      <div class="page-actions">
        <app-button variant="outline" (click)="goToDashboard()">
          üìä Dashboard
        </app-button>
        <app-button variant="primary" (click)="openCreateReadingModal()">
          + Add Reading
        </app-button>
      </div>
    </div>

    <!-- Loading -->
    <div *ngIf="isLoading" class="loading-container">
      <app-loading-spinner message="Loading bin readings..."></app-loading-spinner>
    </div>

    <!-- Content -->
    <div *ngIf="!isLoading">

      <!-- Readings Count -->
      <div class="readings-info">
        <span class="info-text">{{ filteredBinReadings.length }} readings</span>
      </div>

      <!-- Readings Table -->
      <div class="readings-section">
        <h2 class="section-title">Recent Readings</h2>

        <div class="readings-table-wrapper">
          <table class="readings-table" *ngIf="filteredBinReadings.length > 0">
            <thead>
              <tr>
                <th>Bin ID</th>
                <th>Timestamp</th>
                <th>Fill %</th>
                <th>Battery %</th>
                <th>Temperature (¬∞C)</th>
                <th>Signal (dBm)</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let reading of filteredBinReadings" (click)="selectReading(reading)" class="reading-row">
                <td class="bin-id-cell">{{ reading.binId }}</td>
                <td class="timestamp-cell">{{ formatDate(reading.ts) }}</td>
                <td class="fill-cell">
                  <div class="progress-bar" [ngClass]="getStatusClass(reading.fillPct, 'fill')">
                    <div class="progress-fill" [style.width.%]="reading.fillPct" [ngClass]="getStatusClass(reading.fillPct, 'fill')"></div>
                    <span class="progress-text">{{ reading.fillPct }}%</span>
                  </div>
                </td>
                <td class="battery-cell">
                  <span class="badge" [ngClass]="'badge-' + getStatusClass(reading.batteryPct, 'battery')">
                    {{ reading.batteryPct }}%
                  </span>
                </td>
                <td class="temperature-cell">{{ reading.temperatureC }}¬∞C</td>
                <td class="signal-cell">{{ reading.signalDbm }} dBm</td>
                <td class="actions-cell">
                  <app-button
                    variant="outline"
                    size="sm"
                    (click)="openEditReadingModal(reading); $event.stopPropagation()">
                    Edit
                  </app-button>
                  <app-button
                    variant="outline"
                    size="sm"
                    (click)="onDeleteReading(reading.id); $event.stopPropagation()">
                    Delete
                  </app-button>
                </td>
              </tr>
            </tbody>
          </table>

          <div *ngIf="filteredBinReadings.length === 0" class="no-items">
            <p>No readings match your filters</p>
          </div>
        </div>
      </div>

    </div>
  </div>
</main>

<!-- Reading Details Modal -->
<app-modal
  [isOpen]="selectedReading !== null"
  [title]="selectedReading ? 'Reading Details - ' + selectedReading.binId : ''"
  size="md"
  (close)="deselectReading()">

  <div class="reading-details-modal" *ngIf="selectedReading">

    <div class="detail-section">
      <div class="detail-row">
        <span class="detail-label">Bin ID:</span>
        <span class="detail-value">{{ selectedReading.binId }}</span>
      </div>

      <div class="detail-row">
        <span class="detail-label">Timestamp:</span>
        <span class="detail-value">{{ formatDate(selectedReading.ts) }}</span>
      </div>

      <div class="detail-row">
        <span class="detail-label">Fill Level:</span>
        <span class="detail-value">{{ selectedReading.fillPct }}%</span>
      </div>

      <div class="detail-row">
        <span class="detail-label">Battery Level:</span>
        <span class="detail-value">{{ selectedReading.batteryPct }}%</span>
      </div>

      <div class="detail-row">
        <span class="detail-label">Temperature:</span>
        <span class="detail-value">{{ selectedReading.temperatureC }}¬∞C</span>
      </div>

      <div class="detail-row">
        <span class="detail-label">Signal Strength:</span>
        <span class="detail-value">{{ selectedReading.signalDbm }} dBm</span>
      </div>
    </div>

    <div class="modal-actions">
      <app-button
        variant="outline"
        size="sm"
        (click)="openEditReadingModal(selectedReading)">
        Edit
      </app-button>

      <app-button
        variant="outline"
        size="sm"
        (click)="onDeleteReading(selectedReading.id)">
        Delete
      </app-button>
    </div>

  </div>
</app-modal>

<!-- Create / Edit Modal -->
<app-modal
  [isOpen]="isFormModalOpen"
  [title]="formMode === 'create' ? 'Add New Reading' : 'Edit Reading'"
  size="md"
  (close)="closeFormModal()">

  <form (ngSubmit)="onSubmitForm()" class="reading-form">

    <div class="form-group">
      <label class="form-label">Bin ID</label>
      <input
        type="text"
        [(ngModel)]="binReadingForm.binId"
        name="binId"
        class="form-input"
        required
      >
    </div>

    <div class="form-group">
      <label class="form-label">Timestamp</label>
      <input
        type="datetime-local"
        [(ngModel)]="binReadingForm.ts"
        name="ts"
        class="form-input"
        required
      >
    </div>

    <div class="form-group">
      <label class="form-label">Fill Level (%)</label>
      <input
        type="number"
        [(ngModel)]="binReadingForm.fillPct"
        name="fillPct"
        class="form-input"
        min="0"
        max="100"
        required
      >
    </div>

    <div class="form-group">
      <label class="form-label">Battery Level (%)</label>
      <input
        type="number"
        [(ngModel)]="binReadingForm.batteryPct"
        name="batteryPct"
        class="form-input"
        min="0"
        max="100"
        required
      >
    </div>

    <div class="form-group">
      <label class="form-label">Temperature (¬∞C)</label>
      <input
        type="number"
        [(ngModel)]="binReadingForm.temperatureC"
        name="temperatureC"
        class="form-input"
        step="0.1"
        required
      >
    </div>

    <div class="form-group">
      <label class="form-label">Signal Strength (dBm)</label>
      <input
        type="number"
        [(ngModel)]="binReadingForm.signalDbm"
        name="signalDbm"
        class="form-input"
        required
      >
    </div>

    <div class="modal-actions">
      <app-button
        type="button"
        variant="outline"
        (click)="closeFormModal()">
        Cancel
      </app-button>
      <app-button type="submit" variant="primary">
        {{ formMode === 'create' ? 'Add Reading' : 'Save Changes' }}
      </app-button>
    </div>

  </form>
</app-modal>
