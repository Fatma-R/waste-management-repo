<main class="admin-page">
  <div class="container">
    <!-- Page Header -->
    <div class="page-header">
      <div>
        <h1 class="page-title">Operations Dashboard</h1>
        <p class="page-subtitle">
          Real-time overview of collections, incidents and resources
        </p>
      </div>

      <div class="admin-badge">
        <span class="badge-text">Admin</span>
        <span class="badge-icon" aria-hidden="true">ğŸ‘‘</span>
      </div>
    </div>

    <!-- Loading -->
    <div *ngIf="isLoading" class="loading-container">
      <app-loading-spinner message="Loading operational data..."></app-loading-spinner>
    </div>

    <!-- Main Content -->
    <div *ngIf="!isLoading">
      <!-- KPI Row -->
      <section class="kpi-section">
        <app-kpi
          label="Employees"
          [value]="totalEmployees"
          icon="ğŸ‘¥"
          color="sage">
        </app-kpi>

        <app-kpi
          label="Vehicles"
          [value]="totalVehicles"
          icon="ğŸšš"
          color="green">
        </app-kpi>

        <app-kpi
          label="Active TournÃ©es"
          [value]="activeTournees"
          icon="ğŸ—ºï¸"
          color="amber">
        </app-kpi>

        <app-kpi
          label="Open Incidents"
          [value]="openIncidentsCount"
          icon="âš ï¸"
          color="red">
        </app-kpi>

        <app-kpi
          label="Collection Points"
          [value]="totalCollectionPoints"
          icon="ğŸ“"
          color="sage">
        </app-kpi>

        <app-kpi
          label="Avg Fill Level"
          [value]="avgNetworkFillPct + '%'"
          icon="ğŸ—‘ï¸"
          color="green">
        </app-kpi>
      </section>

      <!-- Grid -->
      <div class="admin-grid">
        <!-- Employee Management -->
        <app-card padding="lg" class="management-card">
          <div class="card-header">
            <h2 class="card-title">Employee Management</h2>
            <a routerLink="/admin/employees" class="card-link">View All â†’</a>
          </div>

          <div class="management-list">
            <div
              *ngFor="let employee of employees.slice(0, 5)"
              class="management-item">
              <div class="item-info">
                <span class="item-icon" aria-hidden="true">ğŸ‘¤</span>
                <div class="item-details">
                  <span class="item-name">{{ employee.fullName }}</span>
                  <span class="item-meta">
                    {{ employee.email }} Â· {{ employee.skill }}
                  </span>
                </div>
              </div>
              <div class="item-actions">
                <span class="status-badge status-active">
                  Active
                </span>
                <button
                  class="action-btn"
                  (click)="openAssignEmployeeModal(employee)"
                  aria-label="Assign employee to tournee">
                  ğŸ“Œ
                </button>
                <button
                  class="action-btn action-delete"
                  (click)="openDeleteEmployeeModal(employee.id)"
                  aria-label="Delete employee">
                  ğŸ—‘ï¸
                </button>
              </div>
            </div>
          </div>
        </app-card>

        <!-- Collection Points & Bins -->
        <app-card padding="lg" class="management-card">
          <div class="card-header">
            <h2 class="card-title">Collection Points & Bins</h2>
            <a routerLink="/map" class="card-link">View Map â†’</a>
          </div>

          <div class="management-list">
            <div
              *ngFor="let cp of collectionPoints.slice(0, 5)"
              class="management-item">
              <div class="item-info">
                <span class="item-icon" aria-hidden="true">ğŸ“</span>
                <div class="item-details">
                  <span class="item-name">
                    {{ cp.adresse }}
                  </span>
                  <span class="item-meta">
                    Bins: {{ cp.binsCount }}
                    Â· Alerts: {{ cp.alertsCount }}
                    Â· Avg fill: {{ cp.avgFillPct }}%
                  </span>
                </div>
              </div>
              <div class="item-actions">
                <span
                  class="status-badge"
                  [ngClass]="cp.active ? 'status-active' : 'status-inactive'">
                  {{ cp.active ? 'Active' : 'Inactive' }}
                </span>
                <button
                  class="action-btn"
                  (click)="openCollectionPointDetails(cp)"
                  aria-label="View collection point details">
                  ğŸ”
                </button>
              </div>
            </div>
          </div>
        </app-card>

        <!-- Today's TournÃ©es -->
        <app-card padding="lg" class="management-card">
          <div class="card-header">
            <h2 class="card-title">Todayâ€™s TournÃ©es</h2>
            <a routerLink="/tournees" class="card-link">Planning â†’</a>
          </div>

          <div class="management-list">
            <div
              *ngFor="let t of todayTournees.slice(0, 5)"
              class="management-item">
              <div class="item-info">
                <span class="item-icon" aria-hidden="true">ğŸ—ºï¸</span>
                <div class="item-details">
                  <span class="item-name">
                    {{ t.label }}
                  </span>
                  <span class="item-meta">
                    {{ t.tourneeType }} Â· {{ t.zoneLabel }}
                    Â· Km: {{ t.plannedKm }}
                    Â· COâ‚‚: {{ t.plannedCO2 }} kg
                    Â· Stops: {{ t.stepsCount }}
                  </span>
                </div>
              </div>
              <div class="item-actions">
                <span
                  class="status-badge"
                  [ngClass]="getTourneeStatusClass(t.status)">
                  {{ t.status }}
                </span>
              </div>
            </div>
          </div>
        </app-card>

        <!-- Vehicles -->
        <app-card padding="lg" class="management-card">
          <div class="card-header">
            <h2 class="card-title">Vehicles</h2>
            <a routerLink="/vehicles" class="card-link">Manage â†’</a>
          </div>

          <div class="management-list">
            <div
              *ngFor="let v of vehicles.slice(0, 5)"
              class="management-item">
              <div class="item-info">
                <span class="item-icon" aria-hidden="true">ğŸšš</span>
                <div class="item-details">
                  <span class="item-name">
                    {{ v.plateNumber }} Â· {{ v.type }}
                  </span>
                  <span class="item-meta">
                    Capacity: {{ v.capacityVolumeL }} L
                    Â· {{ v.zoneLabel }}
                  </span>
                </div>
              </div>
              <div class="item-actions">
                <span
                  class="status-badge"
                  [ngClass]="getVehicleStatusClass(v.status)">
                  {{ v.status }}
                </span>
                <button
                  class="action-btn"
                  (click)="openVehicleMaintenanceModal(v)"
                  aria-label="Register maintenance">
                  ğŸ› ï¸
                </button>
              </div>
            </div>
          </div>
        </app-card>

        <!-- Incidents -->
        <app-card padding="lg" class="activity-card">
          <div class="card-header">
            <h2 class="card-title">Recent Incidents</h2>
            <a routerLink="/incidents" class="card-link">View All â†’</a>
          </div>

          <div class="activity-list">
            <div
              *ngFor="let incident of recentIncidents.slice(0, 6)"
              class="activity-item">
              <span class="activity-icon" aria-hidden="true">
                {{ getIncidentTypeIcon(incident.type) }}
              </span>
              <div class="activity-content">
                <div class="activity-header">
                  <span class="activity-user">
                    {{ incident.contextLabel }}
                  </span>
                  <span class="activity-time">
                    {{ formatTimestamp(incident.reportedAt) }}
                  </span>
                </div>
                <p class="activity-action">
                  {{ incident.description }}
                </p>
                <p class="activity-details">
                  <span class="status-badge" [ngClass]="getIncidentSeverityClass(incident.severity)">
                    {{ incident.severity }}
                  </span>
                  <span class="status-badge" [ngClass]="getIncidentStatusClass(incident.status)">
                    {{ incident.status }}
                  </span>
                  <span *ngIf="incident.reportedBy">
                    Â· Reported by: {{ incident.reportedBy }}
                  </span>
                </p>
              </div>
            </div>
          </div>
        </app-card>

        <!-- Activity Logs -->
        <app-card padding="lg" class="activity-card">
          <div class="card-header">
            <h2 class="card-title">Activity Logs</h2>
          </div>

          <div class="activity-list">
            <div
              *ngFor="let log of activityLogs"
              class="activity-item">
              <span class="activity-icon" aria-hidden="true">
                {{ getActivityIcon(log.type) }}
              </span>
              <div class="activity-content">
                <div class="activity-header">
                  <span class="activity-user">{{ log.user }}</span>
                  <span class="activity-time">
                    {{ formatTimestamp(log.timestamp) }}
                  </span>
                </div>
                <p class="activity-action">{{ log.action }}</p>
                <p class="activity-details">{{ log.details }}</p>
              </div>
            </div>
          </div>
        </app-card>

        <!-- System Controls -->
        <app-card padding="lg" class="controls-card">
          <div class="card-header">
            <h2 class="card-title">System Controls</h2>
          </div>

          <div class="controls-grid">
            <button class="control-button" (click)="onRecalculateTournees()">
              <span class="control-icon" aria-hidden="true">ğŸ§®</span>
              <span class="control-label">Recalculate TournÃ©es</span>
            </button>

            <button class="control-button" (click)="onRebalanceBins()">
              <span class="control-icon" aria-hidden="true">âš–ï¸</span>
              <span class="control-label">Rebalance Collection Points</span>
            </button>

            <button class="control-button" (click)="onExportKpiReport()">
              <span class="control-icon" aria-hidden="true">ğŸ“Š</span>
              <span class="control-label">Export KPI Report</span>
            </button>

            <button class="control-button" (click)="onExportIncidentReport()">
              <span class="control-icon" aria-hidden="true">ğŸ“‘</span>
              <span class="control-label">Export Incidents</span>
            </button>

            <button class="control-button" (click)="onSyncWithSensors()">
              <span class="control-icon" aria-hidden="true">ğŸ“¡</span>
              <span class="control-label">Sync with Sensors</span>
            </button>

            <button class="control-button" (click)="onOpenSystemSettings()">
              <span class="control-icon" aria-hidden="true">âš™ï¸</span>
              <span class="control-label">Manage Administrators</span>
            </button>
          </div>
        </app-card>
      </div>
    </div>
  </div>
</main>

<!-- Delete Employee Confirmation Modal -->
<app-modal
  [isOpen]="isDeleteEmployeeModalOpen"
  title="Delete Employee"
  size="sm"
  (close)="closeDeleteEmployeeModal()">
  <div class="confirm-modal">
    <p class="modal-description">
      Are you sure you want to delete this employee? This action cannot be undone.
    </p>
    <div class="modal-actions">
      <app-button
        variant="outline"
        (click)="closeDeleteEmployeeModal()">
        Cancel
      </app-button>
      <app-button
        variant="primary"
        (click)="confirmDeleteEmployee()">
        Delete Employee
      </app-button>
    </div>
  </div>
</app-modal>

<!-- Delete Bin Confirmation Modal -->
<app-modal
  [isOpen]="isDeleteBinModalOpen"
  title="Delete Bin"
  size="sm"
  (close)="closeDeleteBinModal()">
  <div class="confirm-modal">
    <p class="modal-description">
      Are you sure you want to delete this bin? This action cannot be undone.
    </p>
    <div class="modal-actions">
      <app-button
        variant="outline"
        (click)="closeDeleteBinModal()">
        Cancel
      </app-button>
      <app-button
        variant="primary"
        (click)="confirmDeleteBin()">
        Delete Bin
      </app-button>
    </div>
  </div>
</app-modal>
