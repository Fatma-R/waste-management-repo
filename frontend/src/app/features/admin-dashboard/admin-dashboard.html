<!-- Toasts -->
<div *ngIf="assignSuccessMessage" class="toast toast-success">
  <span class="toast-icon">‚úÖ</span>
  <span class="toast-text">{{ assignSuccessMessage }}</span>
</div>

<div *ngIf="assignErrorMessage" class="toast toast-error">
  <span class="toast-icon">‚ö†Ô∏è</span>
  <span class="toast-text">{{ assignErrorMessage }}</span>
</div>

<main class="admin-page">
  <div class="container">
    <!-- Page Header -->
    <div class="page-header">
      <div>
        <h1 class="page-title">Operations Dashboard</h1>
        <p class="page-subtitle">
          Real-time overview of collections, incidents and resources
        </p>
      </div>

      <div class="admin-badge">
        <span class="badge-text">Admin</span>
        <span class="badge-icon" aria-hidden="true">üëë</span>
      </div>
    </div>

    <!-- Loading -->
    <div *ngIf="isLoading" class="loading-container">
      <app-loading-spinner message="Loading operational data..."></app-loading-spinner>
    </div>

    <!-- Main Content -->
    <div *ngIf="!isLoading">
      <!-- KPI Row -->
      <section class="kpi-section">
        <app-kpi
          label="Employees"
          [value]="totalEmployees"
          icon="üë•"
          color="sage">
        </app-kpi>

        <app-kpi
          label="Vehicles"
          [value]="totalVehicles"
          icon="üöö"
          color="green">
        </app-kpi>

        <app-kpi
          label="Active Tourn√©es"
          [value]="activeTournees"
          icon="üó∫Ô∏è"
          color="amber">
        </app-kpi>

        <app-kpi
          label="Open Incidents"
          [value]="openIncidentsCount"
          icon="‚ö†Ô∏è"
          color="red">
        </app-kpi>

        <app-kpi
          label="Collection Points"
          [value]="totalCollectionPoints"
          icon="üìç"
          color="sage">
        </app-kpi>

      

        <app-kpi
          label="Alerts"
          [value]="totalAlerts"
          icon="üö®"
          color="red">
        </app-kpi>
      </section>

      <!-- Grid -->
      <div class="admin-grid">
        
        <!-- Map Preview -->
        <app-card padding="lg" class="map-preview-card dashboard-card">

          <div class="card-header">
            <h2 class="card-title">Tournee Map Preview</h2>
          </div>

          <div class="map-body">
            <img src="assets/map/map-preview.png" alt="Map Preview" class="map-preview-img" />
          </div>

          <div class="card-footer">
            <a routerLink="/admin/tournee-map" class="card-link">View Full Map ‚Üí</a>
          </div>

        </app-card>

        <!-- Alerts -->
        <app-card padding="lg" class="management-card dashboard-card">
          <div class="card-header">
            <h2 class="card-title">Recent Alerts</h2>
            <a routerLink="/admin/alerts" class="card-link">View All ‚Üí</a>
          </div>

          <div class="management-list">
            <div *ngFor="let alert of alerts.slice(0, 3)" class="management-item">
      
              <!-- INFO SECTION -->
              <div class="item-info">
                <span class="item-icon" aria-hidden="true">üö®</span>
                <div class="item-details">
                  <span class="item-name">{{ alert.message }}</span>
                  <span class="item-meta">
                    {{ formatTimestamp(alert.createdAt) }}
                  </span>
                </div>
              </div>

              <!-- ACTIONS SECTION -->
              <div class="item-actions">
                <span class="status-badge" [ngClass]="{
                  'status-low': alert.severity === 'LOW',
                  'status-medium': alert.severity === 'MEDIUM',
                  'status-high': alert.severity === 'HIGH',
                  'status-critical': alert.severity === 'CRITICAL'
                  }">
                   {{ alert.severity }}
                </span>
                <span class="status-badge" [ngClass]="alert.resolved ? 'status-resolved' : 'status-open'">
                  {{ alert.resolved ? 'Resolved' : 'Open' }}
                </span>
              </div>

            </div>

            <div *ngIf="alerts.length === 0" class="no-activity">
              <p>No recent alerts</p>
            </div>
          </div>
       </app-card>


        <!-- Employee Management -->
        <app-card padding="lg" class="management-card dashboard-card">
          <div class="card-header">
            <h2 class="card-title">Employee Management</h2>
            <a routerLink="/admin/employees" class="card-link">View All ‚Üí</a>
          </div>

          <div class="management-list">
            <div
              *ngFor="let employee of employees.slice(0, 3)"
              class="management-item">
              <div class="item-info">
                <span class="item-icon" aria-hidden="true">üë§</span>
                <div class="item-details">
                  <span class="item-name">{{ employee.fullName }}</span>
                  <span class="item-meta">
                    {{ employee.email }} ¬∑ {{ employee.skill }}
                  </span>
                </div>
              </div>
              <div class="item-actions">
                <span class="status-badge status-active">
                  Active
                </span>
                <button
                  class="action-btn"
                  (click)="openAssignEmployeeModal(employee)"
                  aria-label="Assign employee to tournee">
                  üìå
                </button>
                <button
                  class="action-btn action-delete"
                  (click)="openDeleteEmployeeModal(employee.id)"
                  aria-label="Delete employee">
                  üóëÔ∏è
                </button>
              </div>
            </div>
            <!-- AUCUN employee -->
            <div *ngIf="employees.length === 0" class="no-employees">
              <p>No employee available</p>
            </div>
          </div>
        </app-card>

        <!-- Collection Points & Bins -->
        <app-card padding="lg" class="management-card dashboard-card">
          <div class="card-header">
            <h2 class="card-title">Collection Points & Bins</h2>
            <a routerLink="/admin/collection-points" class="card-link">
              View All ‚Üí
            </a>
          </div>

          <div class="management-list">
            <div
              *ngFor="let cp of collectionPoints.slice(0, 3)"
              class="management-item">

              <!-- INFO SECTION -->
              <div class="item-info">
                <span class="item-icon" aria-hidden="true">üìç</span>

                <div class="item-details">
                  <span class="item-name">
                    {{ cp.adresse || 'Unknown location' }}
                  </span>
                  <span class="item-meta">
                     Bins: {{ cp.binsCount }} ¬∑ Alerts: {{ cp.alertsCount }} ¬∑ Avg fill: {{ cp.avgFillPct }}%
                  </span>
                </div>
              </div>

              <!-- ACTIONS SECTION -->
              <div class="item-actions">
                <span
                  class="status-badge"
                  [ngClass]="cp.active ? 'status-active' : 'status-inactive'">
                  {{ cp.active ? 'Active' : 'Inactive' }}
                </span>

                <button
                  class="action-btn"
                  (click)="navigateToBins(cp.id)"
                  aria-label="View bins for this collection point">
                  üîé
                </button>

              </div>
            </div>
            <!-- AUCUN Collection Points -->
            <div *ngIf="collectionPoints.length === 0" class="no-collection-points">
              <p>No collection points available</p>
            </div>
          
          </div>
        </app-card>


        <!-- Vehicles -->
        <app-card padding="lg" class="management-card dashboard-card">
          <div class="card-header">
            <h2 class="card-title">Vehicles</h2>
            <a routerLink="/admin/vehicles" class="card-link">Manage ‚Üí</a>
          </div>

          <div class="management-list">
            <div
              *ngFor="let v of vehicles.slice(0, 3)"
              class="management-item"
            >
              <div class="item-info">
                <span class="item-icon" aria-hidden="true">üöö</span>
                <div class="item-details">
                  <span class="item-name">
                    {{ v.plateNumber }}
                  </span>
                  <span class="item-meta">
                    {{ v.fuelType }}
                    ¬∑ {{ v.capacityVolumeL }} L
                  </span>
                </div>
              </div>

              <div class="item-actions">
                <span class="status-badge" [ngClass]="getVehicleStatusClass(v.status)">
                  {{ v.status }}
                </span>

                <button
                  class="action-btn action-delete"
                  (click)="openDeleteVehicleModal(v.id)"
                  aria-label="Delete vehicle">
                  üóëÔ∏è
                </button>

              </div>
            </div>

            <!-- AUCUN v√©hicule -->
            <div *ngIf="vehicles.length === 0" class="no-vehicles">
              <p>No vehicles available</p>
            </div>
          </div>
        </app-card>

        <!-- Incidents -->
        <app-card padding="lg" class="management-card dashboard-card">
          <div class="card-header">
            <h2 class="card-title">Recent Incidents</h2>
            <a routerLink="/admin/incidents" class="card-link">View All ‚Üí</a>
          </div>

          <div class="management-list">
            <div *ngFor="let incident of recentIncidents.slice(0, 3)" class="management-item">
      
              <!-- INFO SECTION -->
                <div class="item-info">
                  <span class="item-icon" aria-hidden="true">{{ getIncidentTypeIcon(incident.type) }}</span>
                  <div class="item-details">
                    <span class="item-name">{{ incident.contextLabel }}</span>
                    <span class="item-meta">
                      {{ formatTimestamp(incident.reportedAt) }} ¬∑ {{ incident.description }}
                    </span>
                  </div>
                </div>

              <!-- ACTIONS SECTION -->
              <div class="item-actions">
                <span class="status-badge" [ngClass]="getIncidentSeverityClass(incident.severity)">
                  {{ incident.severity }}
                </span>
                <span class="status-badge" [ngClass]="getIncidentStatusClass(incident.status)">
                  {{ incident.status }}
                </span>
              </div>

            </div>

            <div *ngIf="recentIncidents.length === 0" class="no-activity">
              <p>No recent incidents</p>
            </div>
          </div>
        </app-card>



        <!-- System Controls -->
        <app-card padding="lg" class="controls-card dashboard-card">
          <div class="card-header">
            <h2 class="card-title">System Controls</h2>
          </div>

          <div class="auto-mode-panel">
            <div class="panel-top">
              <div>
                <p class="panel-label">Auto Planning Mode</p>
                <p class="panel-hint">Off, emergencies-only or full automation.</p>
              </div>
              <span class="mode-pill" [class.pill-loading]="isModeLoading">
                {{ autoMode || '...' }}
              </span>
            </div>

            <div class="mode-toggle">
              <button
                type="button"
                class="toggle-chip"
                [class.active]="autoMode === AutoMode.OFF"
                [disabled]="isModeLoading"
                (click)="setAutoMode(AutoMode.OFF)">
                <span class="dot dot-muted"></span>
                Off
              </button>
              <button
                type="button"
                class="toggle-chip"
                [class.active]="autoMode === AutoMode.EMERGENCIES_ONLY"
                [disabled]="isModeLoading"
                (click)="setAutoMode(AutoMode.EMERGENCIES_ONLY)">
                <span class="dot dot-amber"></span>
                Emergencies
              </button>
              <button
                type="button"
                class="toggle-chip"
                [class.active]="autoMode === AutoMode.FULL"
                [disabled]="isModeLoading"
                (click)="setAutoMode(AutoMode.FULL)">
                <span class="dot dot-green"></span>
                Full
              </button>
            </div>

            <div class="run-actions">
              <button
                type="button"
                class="run-btn"
                [disabled]="runLoading.scheduled"
                (click)="runScheduled()">
                <span class="run-label">Run scheduled cycle</span>
                <span class="run-sub">Trigger the daily full loop now</span>
                <span class="run-icon" aria-hidden="true">‚Üª</span>
              </button>

              <button
                type="button"
                class="run-btn"
                [disabled]="runLoading.emergency"
                (click)="runEmergency()">
                <span class="run-label">Run emergency loop</span>
                <span class="run-sub">Immediate dispatch respecting mode</span>
                <span class="run-icon" aria-hidden="true">‚ö°</span>
              </button>
            </div>
          </div>

          <div class="controls-grid">
            <button class="control-button" (click)="onRecalculateTournees()">
              <span class="control-icon" aria-hidden="true">üßÆ</span>
              <span class="control-label">Recalculate Tourn√©es</span>
            </button>

            <button class="control-button" (click)="onRebalanceBins()">
              <span class="control-icon" aria-hidden="true">‚öñÔ∏è</span>
              <span class="control-label">Rebalance Collection Points</span>
            </button>

            <button class="control-button" (click)="onExportKpiReport()">
              <span class="control-icon" aria-hidden="true">üìä</span>
              <span class="control-label">Export KPI Report</span>
            </button>

            <button class="control-button" (click)="onExportIncidentReport()">
              <span class="control-icon" aria-hidden="true">üìë</span>
              <span class="control-label">Export Incidents</span>
            </button>

            <button class="control-button" (click)="onSyncWithSensors()">
              <span class="control-icon" aria-hidden="true">üì°</span>
              <span class="control-label">Sync with Sensors</span>
            </button>

            <button class="control-button" (click)="onOpenSystemSettings()">
              <span class="control-icon" aria-hidden="true">‚öôÔ∏è</span>
              <span class="control-label">Manage Administrators</span>
            </button>
          </div>
        </app-card>
        <app-card [ngClass]="{ 'empty-card': alerts.length === 0 }"></app-card>
      </div>
    </div>
  </div>
</main>
