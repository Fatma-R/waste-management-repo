<main class="admin-page">
  <div class="container">
    <!-- Page Header -->
    <div class="page-header">
      <div>
        <h1 class="page-title">Operations Dashboard</h1>
        <p class="page-subtitle">
          Real-time overview of collections, incidents and resources
        </p>
      </div>

      <div class="admin-badge">
        <span class="badge-text">Admin</span>
        <span class="badge-icon" aria-hidden="true">üëë</span>
      </div>
    </div>

    <!-- Loading -->
    <div *ngIf="isLoading" class="loading-container">
      <app-loading-spinner message="Loading operational data..."></app-loading-spinner>
    </div>

    <!-- Main Content -->
    <div *ngIf="!isLoading">
      <!-- KPI Row -->
      <section class="kpi-section">
        <app-kpi
          label="Employees"
          [value]="totalEmployees"
          icon="üë•"
          color="sage">
        </app-kpi>

        <app-kpi
          label="Vehicles"
          [value]="totalVehicles"
          icon="üöö"
          color="green">
        </app-kpi>

        <app-kpi
          label="Active Tourn√©es"
          [value]="activeTournees"
          icon="üó∫Ô∏è"
          color="amber">
        </app-kpi>

        <app-kpi
          label="Open Incidents"
          [value]="openIncidentsCount"
          icon="‚ö†Ô∏è"
          color="red">
        </app-kpi>

        <app-kpi
          label="Collection Points"
          [value]="totalCollectionPoints"
          icon="üìç"
          color="sage">
        </app-kpi>

        <app-kpi
          label="Avg Fill Level"
          [value]="avgNetworkFillPct + '%'"
          icon="üóëÔ∏è"
          color="green">
        </app-kpi>
      </section>

      <!-- Grid -->
      <div class="admin-grid">
        <!-- Employee Management -->
        <app-card padding="lg" class="management-card">
          <div class="card-header">
            <h2 class="card-title">Employee Management</h2>
            <a routerLink="/admin/employees" class="card-link">View All ‚Üí</a>
          </div>

          <div class="management-list">
            <div
              *ngFor="let employee of employees.slice(0, 5)"
              class="management-item">
              <div class="item-info">
                <span class="item-icon" aria-hidden="true">üë§</span>
                <div class="item-details">
                  <span class="item-name">{{ employee.fullName }}</span>
                  <span class="item-meta">
                    {{ employee.email }} ¬∑ {{ employee.skill }}
                  </span>
                </div>
              </div>
              <div class="item-actions">
                <span class="status-badge status-active">
                  Active
                </span>
                <button
                  class="action-btn"
                  (click)="openAssignEmployeeModal(employee)"
                  aria-label="Assign employee to tournee">
                  üìå
                </button>
                <button
                  class="action-btn action-delete"
                  (click)="openDeleteEmployeeModal(employee.id)"
                  aria-label="Delete employee">
                  üóëÔ∏è
                </button>
              </div>
            </div>
          </div>
        </app-card>

        <!-- Collection Points & Bins -->
        <app-card padding="lg" class="management-card">
          <div class="card-header">
            <h2 class="card-title">Collection Points & Bins</h2>
            <a routerLink="/map" class="card-link">View Map ‚Üí</a>
          </div>

          <div class="management-list">
            <div
              *ngFor="let cp of collectionPoints.slice(0, 5)"
              class="management-item">
              <div class="item-info">
                <span class="item-icon" aria-hidden="true">üìç</span>
                <div class="item-details">
                  <span class="item-name">
                    {{ cp.adresse }}
                  </span>
                  <span class="item-meta">
                    Bins: {{ cp.binsCount }}
                    ¬∑ Alerts: {{ cp.alertsCount }}
                    ¬∑ Avg fill: {{ cp.avgFillPct }}%
                  </span>
                </div>
              </div>
              <div class="item-actions">
                <span
                  class="status-badge"
                  [ngClass]="cp.active ? 'status-active' : 'status-inactive'">
                  {{ cp.active ? 'Active' : 'Inactive' }}
                </span>
                <button
                  class="action-btn"
                  (click)="openCollectionPointDetails(cp)"
                  aria-label="View collection point details">
                  üîé
                </button>
              </div>
            </div>
          </div>
        </app-card>

        <!-- Today's Tourn√©es -->
        <app-card padding="lg" class="management-card">
          <div class="card-header">
            <h2 class="card-title">Today‚Äôs Tourn√©es</h2>
            <a routerLink="/tournees" class="card-link">Planning ‚Üí</a>
          </div>

          <div class="management-list">
            <div
              *ngFor="let t of todayTournees.slice(0, 5)"
              class="management-item">
              <div class="item-info">
                <span class="item-icon" aria-hidden="true">üó∫Ô∏è</span>
                <div class="item-details">
                  <span class="item-name">
                    {{ t.label }}
                  </span>
                  <span class="item-meta">
                    {{ t.tourneeType }} ¬∑ {{ t.zoneLabel }}
                    ¬∑ Km: {{ t.plannedKm }}
                    ¬∑ CO‚ÇÇ: {{ t.plannedCO2 }} kg
                    ¬∑ Stops: {{ t.stepsCount }}
                  </span>
                </div>
              </div>
              <div class="item-actions">
                <span
                  class="status-badge"
                  [ngClass]="getTourneeStatusClass(t.status)">
                  {{ t.status }}
                </span>
              </div>
            </div>
          </div>
        </app-card>

        <!-- Vehicles -->
        <app-card padding="lg" class="management-card">
          <div class="card-header">
            <h2 class="card-title">Vehicles</h2>
            <a routerLink="/admin/vehicles" class="card-link">Manage ‚Üí</a>
          </div>

          <div class="management-list">
            <div
              *ngFor="let v of vehicles.slice(0, 3)"
              class="management-item"
            >
              <div class="item-info">
                <span class="item-icon" aria-hidden="true">üöö</span>
                <div class="item-details">
                  <span class="item-name">
                    {{ v.plateNumber }}
                  </span>
                  <span class="item-meta">
                    {{ v.fuelType }}
                    ¬∑ {{ v.capacityVolumeL }} L
                  </span>
                </div>
              </div>

              <div class="item-actions">
                <span class="status-badge" [ngClass]="getVehicleStatusClass(v.status)">
                  {{ v.status }}
                </span>

                <button
                  class="action-btn"
                  (click)="openVehicleMaintenanceModal(v)"
                  aria-label="Register maintenance"
                >
                  üõ†Ô∏è
                </button>
              </div>
            </div>

            <!-- AUCUN v√©hicule -->
            <div *ngIf="vehicles.length === 0" class="no-vehicles">
              <p>No vehicles available</p>
            </div>
          </div>
        </app-card>



        <!-- Incidents -->
        <app-card padding="lg" class="activity-card">
          <div class="card-header">
            <h2 class="card-title">Recent Incidents</h2>
            <a routerLink="/admin/incidents" class="card-link">View All ‚Üí</a>

          </div>

          <div class="activity-list">
            <div
              *ngFor="let incident of recentIncidents.slice(0, 3)"
              class="activity-item"
            >
              <span class="activity-icon" aria-hidden="true">
                {{ getIncidentTypeIcon(incident.type) }}
              </span>

              <div class="activity-content">
                <div class="activity-header">
                  <span class="activity-user">{{ incident.contextLabel }}</span>
                  <span class="activity-time">{{ formatTimestamp(incident.reportedAt) }}</span>
                </div>

                <p class="activity-action">{{ incident.description }}</p>

                <p class="activity-details">
                  <span class="status-badge" [ngClass]="getIncidentSeverityClass(incident.severity)">
                    {{ incident.severity }}
                  </span>
                  <span class="status-badge" [ngClass]="getIncidentStatusClass(incident.status)">
                    {{ incident.status }}
                  </span>
                  <!--<span *ngIf="incident.reportedBy">
                    ¬∑ Reported by: {{ incident.reportedBy }}
                  </span>-->
                </p>
              </div>
            </div>

            <!-- Message si aucun incident -->
            <div *ngIf="recentIncidents.length === 0" class="no-activity">
              <p>No recent incidents</p>
            </div>
          </div>
        
        </app-card>


        <!-- Activity Logs -->
        <app-card padding="lg" class="activity-card">
          <div class="card-header">
            <h2 class="card-title">Activity Logs</h2>
          </div>

          <div class="activity-list">
            <div
              *ngFor="let log of activityLogs"
              class="activity-item">
              <span class="activity-icon" aria-hidden="true">
                {{ getActivityIcon(log.type) }}
              </span>
              <div class="activity-content">
                <div class="activity-header">
                  <span class="activity-user">{{ log.user }}</span>
                  <span class="activity-time">
                    {{ formatTimestamp(log.timestamp) }}
                  </span>
                </div>
                <p class="activity-action">{{ log.action }}</p>
                <p class="activity-details">{{ log.details }}</p>
              </div>
            </div>
          </div>
        </app-card>
        <!-- Alerts -->
        <app-card padding="lg" class="activity-card">
          <div class="card-header">
            <h2 class="card-title">Recent Alerts</h2>
            <a routerLink="/admin/alerts" class="card-link">View All ‚Üí</a>
          </div>

          <div class="activity-list">
            <div
              *ngFor="let alert of alerts.slice(0, 5)"
              class="activity-item"
            >
            <span class="activity-icon" aria-hidden="true">
              üö®
            </span>

              <div class="activity-content">
                <div class="activity-header">
                  <span class="activity-user">{{ alert.severity }}</span>
                  <span class="activity-time">{{ formatTimestamp(alert.createdAt) }}</span>
                </div>

                <p class="activity-action">{{ alert.message }}</p>

                <p class="activity-details">
                  <span class="status-badge" [ngClass]="{
                    'status-low': alert.severity === 'LOW',
                    'status-medium': alert.severity === 'MEDIUM',
                    'status-high': alert.severity === 'HIGH',
                    'status-critical': alert.severity === 'CRITICAL'
                  }">
                    {{ alert.severity }}
                  </span>
                  <span class="status-badge" [ngClass]="alert.resolved ? 'status-resolved' : 'status-open'">
                    {{ alert.resolved ? 'Resolved' : 'Open' }}
                  </span>
                </p>
              </div>
            </div>

            <div *ngIf="alerts.length === 0" class="no-activity">
              <p>No recent alerts</p>
            </div>
          </div>
        </app-card>


        <!-- System Controls -->
        <app-card padding="lg" class="controls-card">
          <div class="card-header">
            <h2 class="card-title">System Controls</h2>
          </div>

          <div class="controls-grid">
            <button class="control-button" (click)="onRecalculateTournees()">
              <span class="control-icon" aria-hidden="true">üßÆ</span>
              <span class="control-label">Recalculate Tourn√©es</span>
            </button>

            <button class="control-button" (click)="onRebalanceBins()">
              <span class="control-icon" aria-hidden="true">‚öñÔ∏è</span>
              <span class="control-label">Rebalance Collection Points</span>
            </button>

            <button class="control-button" (click)="onExportKpiReport()">
              <span class="control-icon" aria-hidden="true">üìä</span>
              <span class="control-label">Export KPI Report</span>
            </button>

            <button class="control-button" (click)="onExportIncidentReport()">
              <span class="control-icon" aria-hidden="true">üìë</span>
              <span class="control-label">Export Incidents</span>
            </button>

            <button class="control-button" (click)="onSyncWithSensors()">
              <span class="control-icon" aria-hidden="true">üì°</span>
              <span class="control-label">Sync with Sensors</span>
            </button>

            <button class="control-button" (click)="onOpenSystemSettings()">
              <span class="control-icon" aria-hidden="true">‚öôÔ∏è</span>
              <span class="control-label">Manage Administrators</span>
            </button>
          </div>
        </app-card>
      </div>
    </div>
  </div>
</main>

<!-- Delete Employee Confirmation Modal -->
<app-modal
  [isOpen]="isDeleteEmployeeModalOpen"
  title="Delete Employee"
  size="sm"
  (close)="closeDeleteEmployeeModal()">
  <div class="confirm-modal">
    <p class="modal-description">
      Are you sure you want to delete this employee? This action cannot be undone.
    </p>
    <div class="modal-actions">
      <app-button
        variant="outline"
        (click)="closeDeleteEmployeeModal()">
        Cancel
      </app-button>
      <app-button
        variant="primary"
        (click)="confirmDeleteEmployee()">
        Delete Employee
      </app-button>
    </div>
  </div>
</app-modal>

<!-- Delete Bin Confirmation Modal -->
<app-modal
  [isOpen]="isDeleteBinModalOpen"
  title="Delete Bin"
  size="sm"
  (close)="closeDeleteBinModal()">
  <div class="confirm-modal">
    <p class="modal-description">
      Are you sure you want to delete this bin? This action cannot be undone.
    </p>
    <div class="modal-actions">
      <app-button
        variant="outline"
        (click)="closeDeleteBinModal()">
        Cancel
      </app-button>
      <app-button
        variant="primary"
        (click)="confirmDeleteBin()">
        Delete Bin
      </app-button>
    </div>
  </div>
</app-modal>
